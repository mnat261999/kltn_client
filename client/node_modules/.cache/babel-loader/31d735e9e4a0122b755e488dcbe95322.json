{"ast":null,"code":"var _jsxFileName = \"D:\\\\Kltn\\\\test\\\\social-media\\\\client\\\\src\\\\components\\\\Header_Footer\\\\Footer\\\\index.js\";\nimport React, { Component } from 'react';\nimport './footer.scss';\nimport Pusher, { Members } from 'pusher-js';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport faCompass from '@fortawesome/fontawesome-free-solid/faCompass';\nimport faPhone from '@fortawesome/fontawesome-free-solid/faPhone';\nimport faClock from '@fortawesome/fontawesome-free-solid/faClock';\nimport faEnvelope from '@fortawesome/fontawesome-free-solid/faEnvelope';\nimport { getIceServers } from '../../../actions/message_action';\nimport Collapse from '@material-ui/core/Collapse';\nimport { Point, Phone, Video, Microphone, MicrophoneOff, VideoOff, X } from 'tabler-icons-react';\nimport Card from '@material-ui/core/Card';\nimport { Link, withRouter } from 'react-router-dom';\nimport { connect } from 'react-redux';\nimport ReactDOM from 'react-dom';\n\nclass Footer extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      checked: false,\n      onlineusers: [],\n      calling: false\n    };\n\n    this.prepareCaller = () => {\n      //Initializing a peer connection\n      var servers = {\n        'iceServers': [{\n          \"url\": \"stun:global.stun.twilio.com:3478?transport=udp\",\n          \"urls\": \"stun:global.stun.twilio.com:3478?transport=udp\"\n        }, {\n          \"url\": \"turn:global.turn.twilio.com:3478?transport=udp\",\n          \"username\": \"68e4f24ef90901b45e096ebc937611bb27c33656214c08d4b1885c9c19c240f1\",\n          \"urls\": \"turn:global.turn.twilio.com:3478?transport=udp\",\n          \"credential\": \"3rxn3/JfFZpyRMIU+j/8kuEvmhyihxy++8Icf+/LTFw=\"\n        }, {\n          \"url\": \"turn:global.turn.twilio.com:3478?transport=tcp\",\n          \"username\": \"68e4f24ef90901b45e096ebc937611bb27c33656214c08d4b1885c9c19c240f1\",\n          \"urls\": \"turn:global.turn.twilio.com:3478?transport=tcp\",\n          \"credential\": \"3rxn3/JfFZpyRMIU+j/8kuEvmhyihxy++8Icf+/LTFw=\"\n        }, {\n          \"url\": \"turn:global.turn.twilio.com:443?transport=tcp\",\n          \"username\": \"68e4f24ef90901b45e096ebc937611bb27c33656214c08d4b1885c9c19c240f1\",\n          \"urls\": \"turn:global.turn.twilio.com:443?transport=tcp\",\n          \"credential\": \"3rxn3/JfFZpyRMIU+j/8kuEvmhyihxy++8Icf+/LTFw=\"\n        }]\n      };\n      this.caller = new window.RTCPeerConnection(servers); //Listen for ICE Candidates and send them to remote peers\n\n      this.caller.onicecandidate = evt => {\n        if (!evt.candidate) return;\n        console.log(\"onicecandidate called\");\n        this.onIceCandidate(this.caller, evt);\n      }; //onaddstream handler to receive remote feed and show in remoteview video element\n\n\n      this.caller.onaddstream = evt => {\n        console.log(\"onaddstream called\");\n\n        if (window.URL) {\n          document.getElementById(\"remoteview\").srcObject = evt.stream;\n          document.getElementById(\"remoteview\").play();\n          document.getElementById(\"remoteview\").muted = false;\n        } else {\n          document.getElementById(\"remoteview\").src = evt.stream;\n          document.getElementById(\"remoteview\").play();\n          document.getElementById(\"remoteview\").muted = false;\n        }\n      };\n    };\n\n    this.getCam = () => {\n      //Get local audio/video feed and show it in selfview video element \n      return navigator.mediaDevices.getUserMedia({\n        video: true,\n        audio: true\n      });\n    };\n\n    this.GetRTCIceCandidate = () => {\n      window.RTCIceCandidate = window.RTCIceCandidate || window.webkitRTCIceCandidate || window.mozRTCIceCandidate || window.msRTCIceCandidate;\n      return window.RTCIceCandidate;\n    };\n\n    this.GetRTCPeerConnection = () => {\n      window.RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection || window.msRTCPeerConnection;\n      return window.RTCPeerConnection;\n    };\n\n    this.GetRTCSessionDescription = () => {\n      window.RTCSessionDescription = window.RTCSessionDescription || window.webkitRTCSessionDescription || window.mozRTCSessionDescription || window.msRTCSessionDescription;\n      return window.RTCSessionDescription;\n    };\n\n    this.callUser = user => {\n      this.getCam().then(stream => {\n        if (window.URL) {\n          document.getElementById(\"selfview\").srcObject = stream;\n          document.getElementById(\"selfview\").play(); // document.getElementById(\"selfview\").srcObject  =  stream;\n        } else {\n          document.getElementById(\"selfview\").src = stream;\n          document.getElementById(\"selfview\").play();\n        }\n\n        this.caller.addStream(stream);\n        this.localUserMedia = stream;\n        this.caller.createOffer().then(desc => {\n          this.caller.setLocalDescription(new RTCSessionDescription(desc));\n          this.channel.trigger(\"client-sdp\", {\n            \"sdp\": desc,\n            \"room\": user,\n            \"from\": this.id,\n            \"userName\": this.props.user.userData.userName,\n            \"avt\": this.props.user.userData.avt\n          });\n          this.room = user;\n        });\n      }).catch(error => {\n        console.log('an error occured', error);\n      });\n    };\n\n    this.endCall = () => {\n      this.room = null;\n      this.caller.close(); // ReactDOM.findDOMNode(this.remoteview).stop()\n      // ReactDOM.findDOMNode(this.selfview).stop()\n\n      for (let track of this.localUserMedia.getTracks()) {\n        track.stop();\n      }\n\n      this.prepareCaller();\n      ReactDOM.findDOMNode(this.videocall_contain).style.display = 'none';\n    };\n\n    this.endCurrentCall = () => {\n      this.channel.trigger(\"client-endcall\", {\n        \"room\": this.room\n      });\n      this.endCall();\n    };\n\n    this.onIceCandidate = (peer, evt) => {\n      if (evt.candidate) {\n        this.channel.trigger(\"client-candidate\", {\n          \"candidate\": evt.candidate,\n          \"room\": this.room\n        });\n      }\n    };\n\n    this.setVisable = () => {\n      ReactDOM.findDOMNode(this.videocall_contain).style.display = 'block';\n    };\n\n    this.toggleCallUser = async userid => {\n      await this.setVisable();\n      await this.callUser(userid);\n    };\n\n    this.sessionDesc = null;\n    this.currentcaller = null;\n    this.room = null;\n    this.caller = null;\n    this.localUserMedia = null;\n    this.id = null;\n    this.userName = null;\n    this.avt = null;\n    this.channel = null;\n    this.usersOnline = 0;\n  }\n\n  componentDidMount() {\n    const script = document.createElement(\"script\");\n    script.src = \"https://js.pusher.com/4.1/pusher.min.js\";\n    script.async = true; //For head\n\n    document.head.appendChild(script); // For body\n\n    document.body.appendChild(script); // For component\n    //   this.div.appendChild(script);\n\n    const list = this.state.onlineusers;\n    const pusher = new Pusher('c0e96b0fff8d0edac17d', {\n      cluster: 'mt1',\n      encrypted: true,\n      authEndpoint: `http://localhost:3002/api/pusher/auth/${this.props.user.userData._id}`\n    });\n    var users = [],\n        sessionDesc,\n        caller,\n        localUserMedia;\n    this.channel = pusher.subscribe('presence-videocall');\n    this.channel.bind('pusher:subscription_succeeded', members => {\n      var me = this.channel.members.me;\n      this.usersOnline = this.channel.members.count;\n      this.id = me.id;\n      console.log(this.channel.members.me); //  document.getElementById('myid').innerHTML = ` My caller id is : ` + id;\n\n      this.channel.members.each(member => {\n        if (member.id != me.id) {\n          list.push(member.info);\n        }\n\n        console.log(list);\n      });\n      this.setState({\n        onlineusers: list\n      });\n    });\n    this.channel.bind('pusher:member_added', member => {\n      list.push(member.info);\n      this.setState({\n        onlineusers: list\n      });\n    });\n    this.channel.bind('pusher:member_removed', member => {\n      // for remove member from list:\n      var index = users.indexOf(member.id);\n      list.splice(index, 1); // if(member.id==room){\n      //     endCall();\n      // }\n\n      this.setState({\n        onlineusers: list\n      });\n    });\n    this.GetRTCPeerConnection();\n    this.GetRTCSessionDescription();\n    this.GetRTCIceCandidate();\n    this.prepareCaller();\n    this.channel.bind(\"client-candidate\", msg => {\n      if (msg.room == this.room) {\n        console.log(\"candidate received\");\n        this.caller.addIceCandidate(new RTCIceCandidate(msg.candidate));\n      }\n    }); //Listening for Session Description Protocol message with session details from remote peer\n\n    this.channel.bind(\"client-sdp\", msg => {\n      if (msg.room == this.id) {\n        var sessionDesc = new RTCSessionDescription(msg.sdp);\n        this.caller.setRemoteDescription(sessionDesc);\n        console.log(\"sdp received\");\n        var answer = window.confirm(\"Bạn có cuộc gọi từ: \" + msg.userName + \" bạn có muốn nhận?\");\n\n        if (!answer) {\n          return this.channel.trigger(\"client-reject\", {\n            \"room\": msg.room,\n            \"rejected\": this.id\n          });\n        }\n\n        ReactDOM.findDOMNode(this.videocall_contain).style.display = 'block';\n        this.room = msg.room;\n        this.getCam().then(stream => {\n          this.localUserMedia = stream;\n\n          if (window.URL) {\n            document.getElementById(\"selfview\").srcObject = stream;\n            document.getElementById(\"selfview\").play();\n          } else {\n            document.getElementById(\"selfview\").src = stream;\n            document.getElementById(\"selfview\").play();\n          }\n\n          this.caller.addStream(stream);\n          this.caller.createAnswer().then(sdp => {\n            this.caller.setLocalDescription(new RTCSessionDescription(sdp));\n            this.channel.trigger(\"client-answer\", {\n              \"sdp\": sdp,\n              \"room\": this.room\n            });\n          });\n        }).catch(error => {\n          console.log('an error occured', error);\n        });\n      }\n    }); //Listening for answer to offer sent to remote peer\n\n    this.channel.bind(\"client-answer\", answer => {\n      if (answer.room == this.room) {\n        console.log(\"answer received\");\n        this.caller.setRemoteDescription(new RTCSessionDescription(answer.sdp));\n      }\n    });\n    this.channel.bind(\"client-reject\", answer => {\n      if (answer.room == this.room) {\n        console.log(\"Call declined\");\n        alert(\"call to \" + answer.rejected + \"was politely declined\");\n        ReactDOM.findDOMNode(this.videocall_contain).style.display = 'none';\n        this.endCall();\n      }\n    });\n    this.channel.bind(\"client-endcall\", answer => {\n      if (answer.room == this.room) {\n        console.log(\"Call Ended\");\n        this.endCall();\n      }\n    });\n  }\n\n  render() {\n    return /*#__PURE__*/React.createElement(\"div\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 321,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      id: \"videocall_contain\",\n      ref: n => this.videocall_contain = n,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 322,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"videocall\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 323,\n        columnNumber: 21\n      }\n    }, /*#__PURE__*/React.createElement(\"video\", {\n      muted: \"muted\",\n      id: \"selfview\",\n      ref: n => this.selfview = n,\n      autoplay: true,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 324,\n        columnNumber: 25\n      }\n    }), /*#__PURE__*/React.createElement(\"video\", {\n      muted: \"muted\",\n      id: \"remoteview\",\n      ref: n => this.remoteview = n,\n      autoplay: true,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 325,\n        columnNumber: 25\n      }\n    }), /*#__PURE__*/React.createElement(\"div\", {\n      className: \"action_button\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 326,\n        columnNumber: 25\n      }\n    }, /*#__PURE__*/React.createElement(Video, {\n      strokeWidth: 1,\n      fill: \"white\",\n      color: \"#7166F9\",\n      id: \"video_button\",\n      size: 30,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 327,\n        columnNumber: 29\n      }\n    }, \" \"), /*#__PURE__*/React.createElement(Microphone, {\n      strokeWidth: 1.5,\n      color: \"white\",\n      id: \"audio_button\",\n      size: 30,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 328,\n        columnNumber: 29\n      }\n    }), /*#__PURE__*/React.createElement(X, {\n      onClick: () => this.endCurrentCall(),\n      strokeWidth: 1.5,\n      color: \"white\",\n      id: \"exit_button\",\n      size: 30,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 329,\n        columnNumber: 29\n      }\n    }, \" \")))), /*#__PURE__*/React.createElement(\"div\", {\n      className: \"footer container-fluid\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 334,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"footer__container container-fluid\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 335,\n        columnNumber: 21\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"row no-gutters\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 337,\n        columnNumber: 25\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"col-lg-9 col-md-6 col-sm-4 col-4 no-gutters\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 338,\n        columnNumber: 29\n      }\n    }), /*#__PURE__*/React.createElement(\"div\", {\n      className: \"col-lg-3 col-md-6 col-sm-8 col-8  no-gutters\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 340,\n        columnNumber: 29\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"footer__container__left\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 341,\n        columnNumber: 33\n      }\n    }, /*#__PURE__*/React.createElement(Collapse, {\n      onClick: () => this.setState({\n        checked: !this.state.checked\n      }),\n      in: this.state.checked,\n      collapsedHeight: 40,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 342,\n        columnNumber: 37\n      }\n    }, /*#__PURE__*/React.createElement(Card, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 343,\n        columnNumber: 41\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"active_footer\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 344,\n        columnNumber: 45\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"title_footer\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 345,\n        columnNumber: 49\n      }\n    }, /*#__PURE__*/React.createElement(\"h4\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 346,\n        columnNumber: 53\n      }\n    }, \"\\u0110ang ho\\u1EA1t \\u0111\\u1ED9ng (\", this.state.onlineusers.length, \")\"), /*#__PURE__*/React.createElement(Point, {\n      size: 20,\n      strokeWidth: 7,\n      color: \"#5fdba7\",\n      fill: \"#5fdba7\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 347,\n        columnNumber: 53\n      }\n    })), /*#__PURE__*/React.createElement(\"hr\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 350,\n        columnNumber: 49\n      }\n    }), /*#__PURE__*/React.createElement(\"div\", {\n      className: \"user_contain\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 351,\n        columnNumber: 49\n      }\n    }, this.state.onlineusers.map(user => {\n      return /*#__PURE__*/React.createElement(\"div\", {\n        className: \"uinfo\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 355,\n          columnNumber: 65\n        }\n      }, /*#__PURE__*/React.createElement(\"img\", {\n        src: user.avt,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 357,\n          columnNumber: 69\n        }\n      }), /*#__PURE__*/React.createElement(\"a\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 358,\n          columnNumber: 69\n        }\n      }, user.userName), /*#__PURE__*/React.createElement(Phone, {\n        onClick: () => {\n          this.toggleCallUser(user.id);\n        },\n        className: \"phone_icon\",\n        size: 24,\n        strokeWidth: 0.5,\n        color: \"black\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 360,\n          columnNumber: 69\n        }\n      }));\n    })))))))))));\n  }\n\n}\n\n;\n\nfunction mapStateToProps(state) {\n  return {\n    user: state.user,\n    notification: state.notification,\n    messages: state.messages\n  };\n}\n\nexport default connect(mapStateToProps)(withRouter(Footer));","map":{"version":3,"sources":["D:/Kltn/test/social-media/client/src/components/Header_Footer/Footer/index.js"],"names":["React","Component","Pusher","Members","FontAwesomeIcon","faCompass","faPhone","faClock","faEnvelope","getIceServers","Collapse","Point","Phone","Video","Microphone","MicrophoneOff","VideoOff","X","Card","Link","withRouter","connect","ReactDOM","Footer","constructor","props","state","checked","onlineusers","calling","prepareCaller","servers","caller","window","RTCPeerConnection","onicecandidate","evt","candidate","console","log","onIceCandidate","onaddstream","URL","document","getElementById","srcObject","stream","play","muted","src","getCam","navigator","mediaDevices","getUserMedia","video","audio","GetRTCIceCandidate","RTCIceCandidate","webkitRTCIceCandidate","mozRTCIceCandidate","msRTCIceCandidate","GetRTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection","msRTCPeerConnection","GetRTCSessionDescription","RTCSessionDescription","webkitRTCSessionDescription","mozRTCSessionDescription","msRTCSessionDescription","callUser","user","then","addStream","localUserMedia","createOffer","desc","setLocalDescription","channel","trigger","id","userData","userName","avt","room","catch","error","endCall","close","track","getTracks","stop","findDOMNode","videocall_contain","style","display","endCurrentCall","peer","setVisable","toggleCallUser","userid","sessionDesc","currentcaller","usersOnline","componentDidMount","script","createElement","async","head","appendChild","body","list","pusher","cluster","encrypted","authEndpoint","_id","users","subscribe","bind","members","me","count","each","member","push","info","setState","index","indexOf","splice","msg","addIceCandidate","sdp","setRemoteDescription","answer","confirm","createAnswer","alert","rejected","render","n","selfview","remoteview","length","map","mapStateToProps","notification","messages"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\r\nimport './footer.scss'\r\nimport Pusher, { Members } from 'pusher-js'\r\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\r\nimport faCompass from '@fortawesome/fontawesome-free-solid/faCompass';\r\nimport faPhone from '@fortawesome/fontawesome-free-solid/faPhone';\r\nimport faClock from '@fortawesome/fontawesome-free-solid/faClock';\r\nimport faEnvelope from '@fortawesome/fontawesome-free-solid/faEnvelope';\r\nimport { getIceServers } from '../../../actions/message_action'\r\nimport Collapse from '@material-ui/core/Collapse'\r\nimport { Point, Phone, Video, Microphone, MicrophoneOff, VideoOff, X } from 'tabler-icons-react'\r\nimport Card from '@material-ui/core/Card';\r\nimport { Link, withRouter } from 'react-router-dom';\r\nimport { connect } from 'react-redux';\r\n\r\nimport ReactDOM from 'react-dom'\r\n\r\nclass Footer extends Component {\r\n    state = {\r\n        checked: false,\r\n        onlineusers: [],\r\n        calling: false,\r\n    }\r\n    constructor(props) {\r\n        super(props)\r\n        this.sessionDesc = null;\r\n        this.currentcaller = null;\r\n        this.room = null;\r\n        this.caller = null;\r\n        this.localUserMedia = null;\r\n        this.id = null;\r\n        this.userName = null;\r\n        this.avt=null;\r\n        this.channel = null;\r\n        this.usersOnline = 0;\r\n    }\r\n    prepareCaller= ()=>{\r\n        //Initializing a peer connection\r\n        var servers = { 'iceServers': [\r\n            {\r\n                \"url\": \"stun:global.stun.twilio.com:3478?transport=udp\",\r\n                \"urls\": \"stun:global.stun.twilio.com:3478?transport=udp\"\r\n            },\r\n            {\r\n                \"url\": \"turn:global.turn.twilio.com:3478?transport=udp\",\r\n                \"username\": \"68e4f24ef90901b45e096ebc937611bb27c33656214c08d4b1885c9c19c240f1\",\r\n                \"urls\": \"turn:global.turn.twilio.com:3478?transport=udp\",\r\n                \"credential\": \"3rxn3/JfFZpyRMIU+j/8kuEvmhyihxy++8Icf+/LTFw=\"\r\n            },\r\n            {\r\n                \"url\": \"turn:global.turn.twilio.com:3478?transport=tcp\",\r\n                \"username\": \"68e4f24ef90901b45e096ebc937611bb27c33656214c08d4b1885c9c19c240f1\",\r\n                \"urls\": \"turn:global.turn.twilio.com:3478?transport=tcp\",\r\n                \"credential\": \"3rxn3/JfFZpyRMIU+j/8kuEvmhyihxy++8Icf+/LTFw=\"\r\n            },\r\n            {\r\n                \"url\": \"turn:global.turn.twilio.com:443?transport=tcp\",\r\n                \"username\": \"68e4f24ef90901b45e096ebc937611bb27c33656214c08d4b1885c9c19c240f1\",\r\n                \"urls\": \"turn:global.turn.twilio.com:443?transport=tcp\",\r\n                \"credential\": \"3rxn3/JfFZpyRMIU+j/8kuEvmhyihxy++8Icf+/LTFw=\"\r\n            }\r\n        ]\r\n        };\r\n        this.caller = new window.RTCPeerConnection(servers);\r\n        //Listen for ICE Candidates and send them to remote peers\r\n        this.caller.onicecandidate = (evt)=> {\r\n            if (!evt.candidate) return;\r\n            console.log(\"onicecandidate called\");\r\n            this.onIceCandidate(this.caller, evt);\r\n        };\r\n        //onaddstream handler to receive remote feed and show in remoteview video element\r\n        this.caller.onaddstream = (evt)=> {\r\n            console.log(\"onaddstream called\");\r\n            if (window.URL) {\r\n                document.getElementById(\"remoteview\").srcObject = evt.stream;   \r\n                document.getElementById(\"remoteview\").play();\r\n                document.getElementById(\"remoteview\").muted=false;\r\n            } else {\r\n                document.getElementById(\"remoteview\").src = evt.stream;\r\n                document.getElementById(\"remoteview\").play();\r\n                document.getElementById(\"remoteview\").muted=false;\r\n            }\r\n        };\r\n    }\r\n    getCam = () => {\r\n        //Get local audio/video feed and show it in selfview video element \r\n        return navigator.mediaDevices.getUserMedia({\r\n            video: true,\r\n            audio: true\r\n        });\r\n    }\r\n\r\n    GetRTCIceCandidate= () =>{\r\n        window.RTCIceCandidate = window.RTCIceCandidate || window.webkitRTCIceCandidate ||\r\n            window.mozRTCIceCandidate || window.msRTCIceCandidate;\r\n\r\n        return window.RTCIceCandidate;\r\n    }\r\n\r\n    GetRTCPeerConnection=() =>{\r\n        window.RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection ||\r\n            window.mozRTCPeerConnection || window.msRTCPeerConnection;\r\n        return window.RTCPeerConnection;\r\n    }\r\n\r\n    GetRTCSessionDescription= ()=> {\r\n        window.RTCSessionDescription = window.RTCSessionDescription || window.webkitRTCSessionDescription ||\r\n            window.mozRTCSessionDescription || window.msRTCSessionDescription;\r\n        return window.RTCSessionDescription;\r\n    }\r\n\r\n    //Create and send offer to remote peer on button click\r\n    callUser = (user) => {\r\n       \r\n        this.getCam()\r\n            .then(stream => {\r\n                if (window.URL) {\r\n                    document.getElementById(\"selfview\").srcObject = stream;\r\n                    document.getElementById(\"selfview\").play()\r\n                    // document.getElementById(\"selfview\").srcObject  =  stream;\r\n                } else {\r\n                    document.getElementById(\"selfview\").src = stream;\r\n                    document.getElementById(\"selfview\").play()\r\n                }\r\n               \r\n                this.caller.addStream(stream);\r\n                this.localUserMedia = stream;\r\n                this.caller.createOffer().then((desc) => {\r\n                    this.caller.setLocalDescription(new RTCSessionDescription(desc));\r\n                    this.channel.trigger(\"client-sdp\", {\r\n                        \"sdp\": desc,\r\n                        \"room\": user,\r\n                        \"from\": this.id,\r\n                        \"userName\": this.props.user.userData.userName,\r\n                        \"avt\": this.props.user.userData.avt\r\n                    });\r\n                    this.room = user;\r\n                });\r\n            \r\n            })\r\n            .catch(error => {\r\n                console.log('an error occured', error);\r\n            })\r\n    };\r\n\r\n    endCall = ()=>{\r\n        this.room = null;\r\n        this.caller.close();\r\n        // ReactDOM.findDOMNode(this.remoteview).stop()\r\n        // ReactDOM.findDOMNode(this.selfview).stop()\r\n        for (let track of this.localUserMedia.getTracks()) { track.stop() }\r\n        this.prepareCaller();\r\n        ReactDOM.findDOMNode(this.videocall_contain).style.display ='none';\r\n    }\r\n\r\n   endCurrentCall= ()=>{\r\n        this.channel.trigger(\"client-endcall\", {\r\n                \"room\": this.room\r\n            });\r\n        this.endCall();\r\n    }\r\n    onIceCandidate = (peer, evt)=> {\r\n        if (evt.candidate) {\r\n            this.channel.trigger(\"client-candidate\", {\r\n                \"candidate\": evt.candidate,\r\n                \"room\": this.room\r\n            });\r\n        }\r\n    }\r\n\r\n  \r\n\r\n    setVisable = ()=>{\r\n        ReactDOM.findDOMNode(this.videocall_contain).style.display ='block';\r\n    }\r\n\r\n    toggleCallUser = async (userid) =>{\r\n       await this.setVisable()\r\n       await this.callUser(userid)\r\n    }\r\n\r\n  \r\n    componentDidMount() {\r\n    const script = document.createElement(\"script\");\r\n    script.src = \"https://js.pusher.com/4.1/pusher.min.js\";\r\n    script.async = true;\r\n\r\n  \r\n    //For head\r\n    document.head.appendChild(script);\r\n\r\n    // For body\r\n    document.body.appendChild(script);\r\n\r\n    // For component\r\n //   this.div.appendChild(script);\r\n        const list = this.state.onlineusers;\r\n        const pusher = new Pusher('c0e96b0fff8d0edac17d', {\r\n            cluster: 'mt1',\r\n            encrypted: true,\r\n            authEndpoint: `http://localhost:3002/api/pusher/auth/${this.props.user.userData._id}`,\r\n        });\r\n        var users = [],\r\n            sessionDesc,\r\n            caller, localUserMedia;\r\n        this.channel = pusher.subscribe('presence-videocall');\r\n        this.channel.bind('pusher:subscription_succeeded', (members) => {\r\n            var me = this.channel.members.me;\r\n            this.usersOnline = this.channel.members.count;\r\n            this.id = me.id;\r\n            console.log(this.channel.members.me)\r\n\r\n            //  document.getElementById('myid').innerHTML = ` My caller id is : ` + id;\r\n            this.channel.members.each((member) => {\r\n                if (member.id != me.id) {\r\n                    list.push(member.info);\r\n                }\r\n                console.log(list)\r\n            });\r\n            this.setState({ onlineusers: list })\r\n        })\r\n        \r\n        this.channel.bind('pusher:member_added', (member) => {\r\n            list.push(member.info)\r\n            this.setState({ onlineusers: list })\r\n        });\r\n        this.channel.bind('pusher:member_removed', (member) => {\r\n            // for remove member from list:\r\n            var index = users.indexOf(member.id);\r\n            list.splice(index, 1);\r\n            // if(member.id==room){\r\n            //     endCall();\r\n            // }\r\n            this.setState({ onlineusers: list })\r\n        });\r\n        this.GetRTCPeerConnection();\r\n        this.GetRTCSessionDescription();\r\n        this.GetRTCIceCandidate();\r\n        this.prepareCaller();\r\n      \r\n\r\nthis.channel.bind(\"client-candidate\", (msg)=> {\r\n      \r\n        if(msg.room==this.room){\r\n            console.log(\"candidate received\");\r\n           this.caller.addIceCandidate(new RTCIceCandidate(msg.candidate));\r\n        }\r\n    });\r\n\r\n    //Listening for Session Description Protocol message with session details from remote peer\r\n    this.channel.bind(\"client-sdp\", (msg) =>{\r\n        if(msg.room == this.id){\r\n            var sessionDesc = new RTCSessionDescription(msg.sdp);\r\n                    this.caller.setRemoteDescription(sessionDesc);\r\n            console.log(\"sdp received\");\r\n            var answer = window.confirm(\"Bạn có cuộc gọi từ: \"+ msg.userName + \" bạn có muốn nhận?\");\r\n            if(!answer){\r\n                return this.channel.trigger(\"client-reject\", {\"room\": msg.room, \"rejected\":this.id});\r\n            }\r\n            ReactDOM.findDOMNode(this.videocall_contain).style.display ='block';\r\n            this.room = msg.room;\r\n            this.getCam()\r\n                .then(stream => {\r\n                    this.localUserMedia = stream;\r\n                    if (window.URL) {\r\n                        document.getElementById(\"selfview\").srcObject = stream;\r\n                        document.getElementById(\"selfview\").play()\r\n                    } else {\r\n\r\n                        document.getElementById(\"selfview\").src = stream;\r\n                        document.getElementById(\"selfview\").play()\r\n                    }\r\n                    this.caller.addStream(stream);\r\n\r\n                    this.caller.createAnswer().then((sdp)=> {\r\n                        this.caller.setLocalDescription(new RTCSessionDescription(sdp));\r\n                        this.channel.trigger(\"client-answer\", {\r\n                            \"sdp\": sdp,\r\n                            \"room\": this.room\r\n                        });\r\n                    });\r\n\r\n                })\r\n                .catch(error => {\r\n                    console.log('an error occured', error);\r\n                })\r\n        }\r\n        \r\n\r\n    });\r\n\r\n    //Listening for answer to offer sent to remote peer\r\n    this.channel.bind(\"client-answer\", (answer) => {\r\n        if(answer.room==this.room){\r\n            console.log(\"answer received\");\r\n            this.caller.setRemoteDescription(new RTCSessionDescription(answer.sdp));\r\n        }\r\n    });\r\n\r\n    this.channel.bind(\"client-reject\", (answer)=> {\r\n        if(answer.room==this.room){\r\n            console.log(\"Call declined\");\r\n            alert(\"call to \" + answer.rejected + \"was politely declined\");\r\n            ReactDOM.findDOMNode(this.videocall_contain).style.display ='none';\r\n            this.endCall();\r\n        }\r\n        \r\n    });\r\n\r\n     this.channel.bind(\"client-endcall\", (answer) =>{\r\n        if(answer.room==this.room){\r\n            console.log(\"Call Ended\");\r\n            this.endCall();\r\n        }\r\n        \r\n    });\r\n\r\n    }\r\n    render() {\r\n        return (\r\n            <div>\r\n                <div  id=\"videocall_contain\" ref={(n) => this.videocall_contain = n} >\r\n                    <div className=\"videocall\">\r\n                        <video muted=\"muted\"  id=\"selfview\" ref={(n) => this.selfview = n} autoplay></video>\r\n                        <video muted=\"muted\" id=\"remoteview\" ref={(n) => this.remoteview = n} autoplay></video>\r\n                        <div className=\"action_button\">\r\n                            <Video strokeWidth={1} fill=\"white\" color=\"#7166F9\" id=\"video_button\" size={30}> </Video>\r\n                            <Microphone strokeWidth={1.5} color=\"white\" id=\"audio_button\" size={30}></Microphone>\r\n                            <X onClick={()=>this.endCurrentCall()} strokeWidth={1.5} color=\"white\" id=\"exit_button\" size={30}> </X>\r\n                        </div>\r\n                    </div>\r\n\r\n                </div>\r\n                <div className=\"footer container-fluid\" >\r\n                    <div className=\"footer__container container-fluid\">\r\n\r\n                        <div className=\"row no-gutters\">\r\n                            <div className=\"col-lg-9 col-md-6 col-sm-4 col-4 no-gutters\">\r\n                            </div>\r\n                            <div className=\"col-lg-3 col-md-6 col-sm-8 col-8  no-gutters\">\r\n                                <div className=\"footer__container__left\">\r\n                                    <Collapse onClick={() => this.setState({ checked: !this.state.checked })} in={this.state.checked} collapsedHeight={40}>\r\n                                        <Card >\r\n                                            <div className=\"active_footer\">\r\n                                                <div className=\"title_footer\">\r\n                                                    <h4>Đang hoạt động ({this.state.onlineusers.length})</h4>\r\n                                                    <Point size={20} strokeWidth={7} color=\"#5fdba7\" fill=\"#5fdba7\"></Point>\r\n\r\n                                                </div>\r\n                                                <hr></hr>\r\n                                                <div className=\"user_contain\">\r\n                                                    {\r\n                                                        this.state.onlineusers.map(user => {\r\n                                                            return (\r\n                                                                <div className=\"uinfo\">\r\n\r\n                                                                    <img src={user.avt}></img>\r\n                                                                    <a>{user.userName}</a>\r\n\r\n                                                                    <Phone onClick={()=>{this.toggleCallUser(user.id)}} className=\"phone_icon\"  size={24} strokeWidth={0.5} color=\"black\"></Phone>\r\n\r\n                                                                </div>\r\n\r\n                                                            )\r\n\r\n                                                        })\r\n                                                    }\r\n                                                </div>\r\n\r\n                                            </div>\r\n\r\n                                        </Card>\r\n                                    </Collapse>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        )\r\n    }\r\n};\r\nfunction mapStateToProps(state) {\r\n    return {\r\n        user: state.user,\r\n        notification: state.notification,\r\n        messages: state.messages\r\n    }\r\n}\r\nexport default connect(mapStateToProps)(withRouter(Footer));"]},"metadata":{},"sourceType":"module"}